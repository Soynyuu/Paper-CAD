# GEMINI.md - Paper-CAD Context for AI Agents

## 1. Project Overview

**Paper-CAD** is a web-based CAD application designed to automatically convert 3D building models into 2D papercraft templates (unfold diagrams/SVG). It bridges the gap between digital 3D models and physical paper models.

- **Goal:** Automate the "unfolding" design process, reducing hours of manual work to seconds.
- **Key Feature:** High-precision 3D-to-2D unfolding using OpenCASCADE Technology.
- **Special Integration:** Deeply integrated with **PLATEAU** (Japan's 3D city data) for fetching and converting real-world building data.
- **Status:** Selected project for **Mitou Junior 2025** (未踏ジュニア).

## 2. Tech Stack & Architecture

### Frontend (`/frontend`)
- **Type:** TypeScript Monorepo (npm workspaces).
- **Framework:** Custom Web Components + CSS Modules (no heavy UI framework like React/Vue).
- **3D Engine:** Three.js (`chili-three` package).
- **CAD Kernel:** OpenCASCADE compiled to WebAssembly (`frontend/cpp/` -> `chili-wasm`).
- **Build Tool:** Rspack.
- **Packages:**
    - `chili-web`: App entry point.
    - `chili-ui`: UI components.
    - `chili-core`: Core data models (Document, Selection, etc.).
    - `chili-three`: 3D rendering integration.
    - `chili-wasm`: WASM bindings.

### Backend (`/backend`)
- **Language:** Python 3.10+.
- **Framework:** FastAPI.
- **CAD Kernel:** pythonOCC (OpenCASCADE bindings).
- **Key Modules:**
    - `core/unfold_engine.py`: The heart of the unfolding logic (Spanning Tree algorithm).
    - `services/citygml/`: Modular pipeline for processing CityGML/PLATEAU data (7 layers, 27 modules).
    - `api/`: FastAPI routers.
- **Environment:** Conda managed (`environment.yml`).

## 3. Development Workflow & Commands

### Frontend
Run from `/frontend`.
- **Install:** `npm install`
- **Dev Server:** `npm run dev` (http://localhost:8080)
- **Demo Mode:** `npm run demo` (Production-like local build)
- **Build Prod:** `npm run build`
- **Build WASM:** `npm run build:wasm` (Requires CMake/Emscripten)
- **Test:** `npm test` (Jest)
- **Format:** `npm run format` (Prettier + clang-format)

### Backend
Run from `/backend`.
- **Setup:** `conda env create -f environment.yml` -> `conda activate paper-cad`
- **Run API:** `python main.py` (http://localhost:8001)
- **Demo Mode:** `ENV=demo python main.py`
- **Test:** `pytest`
- **Docker:** `docker compose up -d`

### Configuration
- **Frontend:** `.env.development`, `.env.demo` (Sets `STEP_UNFOLD_API_URL`).
- **Backend:** `.env.development`, `.env.demo` (Sets `PORT`, `FRONTEND_URL`, `CORS_ALLOW_ALL`).

## 4. Key Conventions & Philosophy

**"Unix Philosophy: Less is More"**
- Write simple, clear, modular code.
- Avoid over-abstraction or unnecessary features.
- **Precision First:** Accurate geometry takes precedence over convenience features.

**Agent Guidelines (from AGENTS_CONTEXT.md):**
1.  **Research First:** Read files before assuming their content.
2.  **Existing Patterns:** Mimic existing code style and structure.
3.  **Glue Tabs (糊代):** Currently **NOT** generated by design. If asked, explain it's a future feature/design choice, not a bug.
4.  **CityGML Safety:** Respect the 7-phase conversion pipeline (Recenter -> XLink -> LOD -> Export).

## 5. Critical File Paths

- **Unfolding Logic:** `backend/core/unfold_engine.py`
- **CityGML Pipeline:** `backend/services/citygml/pipeline/orchestrator.py`
- **API Routes:** `backend/api/endpoints.py`
- **Frontend Entry:** `frontend/packages/chili-web/src/index.ts`
- **UI Components:** `frontend/packages/chili-ui/src/`
- **WASM Source:** `frontend/cpp/src/`

## 6. Testing

- **Frontend:** Jest (`npm test`).
- **Backend:** Pytest (`pytest`).
- **Manual:** Swagger UI at `http://localhost:8001/docs`.
